<div class="row">
  <div class="col-md-12">
    <nb-card class="inline-form-card">
      <nb-card-header>Devoluciones</nb-card-header>
      <nb-card-body>
        <div class="row">

          <div class="col-sm-3">
            <label for="inputDevType" class="label">Tipo Receptor</label>

            <select selected="*" id="inputDevType" style="display:block;" class="form-control" fullWidth
              (change)="onReceptorTypeSelected($event.target.value)" [(ngModel)]="filterParams.tipoReceptor">
              <option value="PROMOTOR">Promotor</option>
              <option value="CLIENTE">Cliente</option>
              <option value="CONTACTO">Contacto</option>
            </select>

          </div>
          <div class="col-sm-3" *ngIf="filterParams.tipoReceptor == 'PROMOTOR'">
            <label for="inputPromotor" class="label">Promotor</label>
            <input id="inputPromotor" class="form-control" type="text" [(ngModel)]="userEmail" disabled
              placeholder="correo contacto">
          </div>
          <div class="col-sm-3" *ngIf="filterParams.tipoReceptor == 'CONTACTO'">
            <label for="inputContacto" class="label">Correo contacto</label>
            <input id="inputContacto" class="form-control" type="text" [(ngModel)]="filterParams.idReceptor" fullWidth
              placeholder="correo contacto">
          </div>
          <div class="col-sm-3" *ngIf="filterParams.tipoReceptor == 'CLIENTE'">
            <label for="inputCliente" class="label">RFC cliente</label>
            <input id="inputCliente" class="form-control" type="text" [(ngModel)]="filterParams.idReceptor" fullWidth
              placeholder="RFC cliente">
          </div>
          <div class="col-sm-3">
            <label for="inputSaldo" class="label">Saldo disponible</label>
            <div class="form-inline">
              <input id="inputSaldo" class="form-control" type="text" [value]="montoDevolucion"  disabled fullWidth>
              <p>&nbsp;&nbsp;&nbsp;&nbsp;</p>
              <button class="btn btn-primary" (click)="searchDevolutionsData()">BUSCAR</button>
            </div>
          </div>

        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>


<div class="row">
  <div class="col-md-12">
    <nb-card>
      <nb-card-header>Solicitud devolución</nb-card-header>
      <nb-card-body>
        <form>
          <div class="form-row">
            <div class="form-group col-md-8">
              <label for="inputBenerficario" class="label">Beneficiario</label>
              <input type="text" class="form-control" id="inputBenerficario" placeholder="Nombre completo beneficiario" [(ngModel)]="solicitud.beneficiario" name="beneficiario g">
            </div>
            <div class="form-group col-md-4">
              <label for="inputImporte" class="label"> Importe a solicitar</label>
              <input type="number" class="form-control" id="inputImporte" placeholder="Importe MXN" [(ngModel)]="solicitud.monto" name="monto">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-3">
              <label for="inputFormaPago" class="label">Forma de Pago</label>
              <select id="inputFormaPago" style="display:block;" class="form-control" [(ngModel)]="solicitud.formaPago" (change)="onPayFormSelected($event.target.value)" name="formapago">
                <option value="*">Seleccionar</option>
                <option value="EFECTIVO">Efectivo</option>
                <option value="CHEQUE">Cheque nominativo</option>
                <option value="TRANSFERENCIA">Transferencia electrónica de fondos</option>
                <option *ngIf="filterParams.tipoReceptor === 'CLIENTE'" value="FACTURA">Pago a factura</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label for="inputBanco" class="label">Banco</label>
              <select id="inputBanco" style="display:block;" class="form-control" [(ngModel)]="solicitud.banco" name="banco">
                <option value="N/A">No Aplica</option>
                <option *ngFor="let bank of banksCat" [value]="bank.nombre">{{bank.nombre}}</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label for="inputTypeRef" class="label">Tipo referencia</label>
              <select id="inputTypeRef" style="display:block;" class="form-control" [(ngModel)]="solicitud.tipoReferencia" name="tiporeferecnia">
                <option value="*">Seleccionar</option>
                <option *ngFor="let type of refTypesCat" [value]="type.id">{{type.nombre}}</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label for="inputReferecnia" class="label">Referencia</label>
              <input type="text" class="form-control" id="inputReferecnia" placeholder="XXXX-XXXX-XXXX" [(ngModel)]="solicitud.referencia" name ="referencia">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="inputObservaciones" class="label">Observaciones/comentarios</label>
              <input type="text" class="form-control" id="inputObservaciones" [(ngModel)]="solicitud.comentarios" name="cometarios"
                placeholder="Observaciones o comentarios adicionales">
            </div>
          </div>
          <button type="submit" class="btn btn-primary" (click)="devolutionRequest(solicitud)">Solicitar Devolucion </button>
        </form>
        <div class="alert alert-warning" *ngIf="messages.length > 0" role="alert">
          <p *ngFor="let message of messages">{{message}}</p>
        </div>
        <br>
        <strong>Devoluciones</strong>
        <div class="clearfix">

          <button type="button" (click)="downloadHandler()" class="btn btn-success float-right">Descarga</button>
          <div *ngIf="pageDevolutions.empty" class="alert alert-primary" role="alert">
            No se encontraron resultados
          </div>
          <div class="table-responsive" *ngIf="!pageDevolutions.empty">
            <table class="table">
              <thead class="thead-light">
                <tr>
                  <th scope="col" class="text-center">Folio Devolucion</th>
                  <th scope="col" class="text-center">Beneficiario</th>
                  <th scope="col" class="text-center">Importe</th>
                  <th scope="col" class="text-center">Forma de pago</th>
                  <th scope="col" class="text-center">Banco</th>
                  <th scope="col" class="text-center">Referencia</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let fila of pageDevolutions.content">
                  <td scope="row" class="text-center"><button class="btn btn-outline-primary btn-sm"
                      (click)="redirectToCfdi(fila.folio)">{{fila.folio}}</button></td>
                  <td scope="row" class="text-center">{{fila.receptor}}</td>
                  <td scope="row" class="text-right">{{fila.monto | currency}}</td>
                  <td scope="row" class="text-center">{{fila.tipoReceptor}}</td>
                  <td scope="row" class="text-center">{{fila.statusDevolucion}}</td>
                  <td scope="row" *ngIf="fila.idPagoDestino!=undefined" class="text-center">
                    <button class="btn btn-outline-primary btn-sm"
                      (click)="openPaymentDetails(dialog,fila.idPagoDestino)"><i class="fa fa-search"></i></button>
                  </td>
                  <td scope="row" *ngIf="fila.idPagoDestino==undefined" class="text-center">
                    <button class="btn btn-sm btn-outline-primary" *ngIf="!fila.solicitud"
                      (click)="addDevolucion(fila)"><i class="fa fa-square"></i></button>
                    <button class="btn btn-sm btn-outline-primary" *ngIf="fila.solicitud"
                      (click)="addDevolucion(fila)"><i class="fa fa-check-square"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ul class="pagination" *ngIf="pageDevolutions.totalElements > 1">
              <li class="page-item" *ngIf="pageDevolutions.first==false"><button class="btn page-link"
                  (click)="updateDataTable(0,pageDevolutions.size)"><i class="nb-arrow-left"></i></button></li>
              <li class="page-item" *ngIf="pageDevolutions.first==false"><button class="btn page-link"
                  (click)="updateDataTable(pageDevolutions.number-1,pageDevolutions.size)">{{pageDevolutions.number}}</button></li>
              <li class="page-item active"><a class="page-link"><strong>{{pageDevolutions.number+1}}</strong></a></li>
              <li class="page-item" *ngIf="pageDevolutions.last==false"><button class="btn page-link"
                  (click)="updateDataTable(pageDevolutions.number+1,pageDevolutions.size)">{{pageDevolutions.number+2}}</button></li>
              <li class="page-item" *ngIf="pageDevolutions.last==false"><button class="btn page-link"
                  (click)="updateDataTable(pageDevolutions.totalPages-1,pageDevolutions.size)"><i class="nb-arrow-right"></i></button></li>
            </ul>
          </div>

        </div>


        <br>
        <strong>Ultimas comisiones / reembolsos generados</strong>
        <div class="clearfix">

          <button type="button" (click)="downloadHandler()" class="btn btn-success float-right">Descarga</button>
          <div *ngIf="pageCommissions.empty" class="alert alert-primary" role="alert">
            No se encontraron resultados
          </div>
          <div class="table-responsive" *ngIf="!pageCommissions.empty">

            <table class="table">
              <thead class="thead-light">
                <tr>
                  <th scope="col" class="text-center">Folio Factura</th>
                  <th scope="col" class="text-center">Tipo Receptor</th>
                  <th scope="col" class="text-center">Receptor</th>
                  <th scope="col" class="text-center">Estatus</th>
                  <th scope="col" class="text-center">Pago/Solicitud</th>
                  <th scope="col" class="text-center">Monto</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let fila of pageCommissions.content">
                  <td scope="row" class="text-center"><button class="btn btn-outline-primary btn-sm"
                      (click)="redirectToCfdi(fila.folio)">{{fila.folio}}</button></td>
                  <td scope="row" class="text-center">{{fila.tipoReceptor}}</td>
                  <td scope="row" class="text-center">{{fila.receptor}}</td>
                  <td scope="row" class="text-center">{{fila.statusDevolucion}}</td>
                  <td scope="row" *ngIf="fila.idPagoDestino!=undefined" class="text-center">
                    <button class="btn btn-outline-primary btn-sm"
                      (click)="openPaymentDetails(dialog,fila.idPagoDestino)"><i class="fa fa-search"></i></button>
                  </td>
                  <td scope="row" *ngIf="fila.idPagoDestino==undefined" class="text-center">
                    <button class="btn btn-sm btn-outline-primary" *ngIf="!fila.solicitud"
                      (click)="addDevolucion(fila)"><i class="fa fa-square"></i></button>
                    <button class="btn btn-sm btn-outline-primary" *ngIf="fila.solicitud"
                      (click)="addDevolucion(fila)"><i class="fa fa-check-square"></i></button>
                  </td>
                  <td scope="row" class="text-right">{{fila.monto | currency}}</td>
                </tr>

              </tbody>
            </table>
            <ul class="pagination" *ngIf="pageCommissions.totalElements > 1">
              <li class="page-item" *ngIf="pageCommissions.first==false"><button class="btn page-link"
                  (click)="updateDataTable(0,pageCommissions.size)"><i class="nb-arrow-left"></i></button></li>
              <li class="page-item" *ngIf="pageCommissions.first==false"><button class="btn page-link"
                  (click)="updateDataTable(pageCommissions.number-1,pageCommissions.size)">{{pageCommissions.number}}</button></li>
              <li class="page-item active"><a class="page-link"><strong>{{pageCommissions.number+1}}</strong></a></li>
              <li class="page-item" *ngIf="pageCommissions.last==false"><button class="btn page-link"
                  (click)="updateDataTable(pageCommissions.number+1,pageCommissions.size)">{{pageCommissions.number+2}}</button></li>
              <li class="page-item" *ngIf="pageCommissions.last==false"><button class="btn page-link"
                  (click)="updateDataTable(pageCommissions.totalPages-1,pageCommissions.size)"><i class="nb-arrow-right"></i></button></li>
            </ul>
          </div>

        </div>

      </nb-card-body>
    </nb-card>
  </div>
</div>

<ng-template #dialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>Detalles Devolucion</nb-card-header>
    <nb-card-body>
      <div class="form-inline">
        <p class="font-weight-bold">Beneficiario</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.comentarioPago}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">Forma de Pago</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.formaPago}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">Monto</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.monto | currency}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">Cuenta/CLABE</p>
        <p>{{data.cuenta}}</p>
      </div>
      <div class="form-inline">
        <p class="font-weight-bold">Banco</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.banco}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">Solicitante</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.createUser}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">Fecha Pago</p>
        &nbsp;&nbsp;&nbsp;
        <p>{{data.fechaPago}}</p>
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
        <p class="font-weight-bold">{{data.statusPago}}</p>

      </div>

    </nb-card-body>
    <nb-card-footer>
      <button class="btn btn-warning" (click)="ref.close()">Salir</button>
    </nb-card-footer>
  </nb-card>
</ng-template>